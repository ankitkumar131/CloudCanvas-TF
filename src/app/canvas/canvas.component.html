<div class="canvas-container" (drop)="onCanvasDrop($event)" (dragover)="onCanvasDragOver($event)">
    <svg #svgCanvas class="canvas-svg" [attr.viewBox]="viewBoxStr()" (mousedown)="onPanStart($event)"
        (mouseup)="onPanEnd()" (mouseleave)="onPanEnd()" (mousemove)="onCanvasMouseMove($event)"
        (click)="onCanvasClick($event)" (wheel)="onWheel($event)" [class.panning]="isPanning()"
        [class.drawing-edge]="isDrawingEdge()">
        <defs>
            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                <polygon points="0 0, 10 3.5, 0 7" fill="#6366f1" />
            </marker>
            <filter id="nodeShadow">
                <feDropShadow dx="0" dy="2" stdDeviation="4" flood-color="#000" flood-opacity="0.3" />
            </filter>
            <filter id="nodeGlow">
                <feGaussianBlur stdDeviation="4" result="blur" />
                <feMerge>
                    <feMergeNode in="blur" />
                    <feMergeNode in="SourceGraphic" />
                </feMerge>
            </filter>
            <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                <circle cx="20" cy="20" r="1" fill="rgba(255,255,255,0.05)" />
            </pattern>
        </defs>

        <rect width="6000" height="4000" x="-1000" y="-1000" fill="url(#grid)" />

        <!-- Edges -->
        @for (edge of edges(); track edge.id) {
        <g class="edge-group">
            <path [attr.d]="getEdgePath(edge.from, edge.to)" fill="none" stroke="transparent" stroke-width="20"
                (click)="removeEdge($event, edge.id)" style="cursor: pointer" />
            <path [attr.d]="getEdgePath(edge.from, edge.to)" fill="none" stroke="#6366f1" stroke-width="2.5"
                marker-end="url(#arrowhead)" pointer-events="none" />
            <!-- Edge label -->
            <text class="edge-label" [attr.x]="getEdgeMidpoint(edge.from, edge.to).x + 10"
                [attr.y]="getEdgeMidpoint(edge.from, edge.to).y" font-size="10" fill="#818cf8">{{ edge.relationship }}</text>
        </g>
        }

        <!-- Edge being drawn -->
        @if (isDrawingEdge() && edgeStartNodeId()) {
        <path class="edge-drawing" [attr.d]="getDrawingEdgePath()" fill="none" stroke="#818cf8" stroke-width="2.5"
            stroke-dasharray="8 4" opacity="0.8" marker-end="url(#arrowhead)" pointer-events="none" />
        <!-- Target hint text -->
        <text class="edge-hint" [attr.x]="edgeCursorPos().x + 15" [attr.y]="edgeCursorPos().y - 10" font-size="11"
            fill="#818cf8" font-weight="500">Click a node to connect</text>
        }

        <!-- Nodes -->
        @for (node of nodes(); track node.id) {
        <g class="node-group" [class.selected]="isSelected(node)" [class.multi-selected]="isMultiSelected() && isSelected(node)" [class.has-error]="hasError(node)"
            [class.has-warning]="hasWarning(node)"
            [class.edge-target]="isDrawingEdge() && edgeStartNodeId() !== node.id"
            [class.edge-target-valid]="isDrawingEdge() && edgeStartNodeId() !== node.id && isValidDropTarget(node.id)"
            [class.edge-target-invalid]="isDrawingEdge() && edgeStartNodeId() !== node.id && !isValidDropTarget(node.id)"
            [attr.transform]="'translate(' + node.position.x + ',' + node.position.y + ')'"
            (click)="onNodeClick($event, node)" (mousedown)="onNodeMouseDown($event, node)">
            <!-- Hit area (slightly larger than visible body for easier clicking) -->
            <rect [attr.width]="NODE_WIDTH + 10" [attr.height]="NODE_HEIGHT + 10" x="-5" y="-5" rx="14" ry="14"
                fill="transparent" />
            <!-- Node body -->
            <rect class="node-body" [attr.width]="NODE_WIDTH" [attr.height]="NODE_HEIGHT" rx="12" ry="12"
                filter="url(#nodeShadow)" />
            <!-- Selection glow -->
            @if (isSelected(node)) {
            <rect class="node-glow" [attr.width]="NODE_WIDTH + 4" [attr.height]="NODE_HEIGHT + 4" x="-2" y="-2" rx="14"
                ry="14" filter="url(#nodeGlow)" />
            }
            <!-- Edge target highlight when drawing edge -->
            @if (isDrawingEdge() && edgeStartNodeId() !== node.id) {
            <rect class="edge-target-glow" [class.edge-target-valid]="isValidDropTarget(node.id)" 
                [class.edge-target-invalid]="!isValidDropTarget(node.id)"
                [attr.width]="NODE_WIDTH + 6" [attr.height]="NODE_HEIGHT + 6" x="-3" y="-3"
                rx="15" ry="15" />
            }
            <!-- Icon -->
            <text class="node-icon" x="16" y="42" font-size="22">{{ getIcon(node) }}</text>
            <!-- Name -->
            <text class="node-name" x="46" y="30" font-size="13" font-weight="600">{{ node.name }}</text>
            <!-- Type -->
            <text class="node-type" x="46" y="48" font-size="10">{{ getDisplayName(node) }}</text>

            <!-- Status badge -->
            @if (hasError(node)) {
            <circle class="node-status node-status--error" [attr.cx]="NODE_WIDTH - 14" cy="12" r="6" />
            } @else if (hasWarning(node)) {
            <circle class="node-status node-status--warning" [attr.cx]="NODE_WIDTH - 14" cy="12" r="6" />
            }

            <!-- CONNECT HANDLE ‚Äî always visible as a bar at the bottom -->
            <g class="node-connector-group" (mousedown)="startEdge($event, node.id)">
                <!-- Wide invisible hit area spanning the full bottom -->
                <rect [attr.x]="0" [attr.y]="NODE_HEIGHT - 4" [attr.width]="NODE_WIDTH" height="24" fill="transparent"
                    rx="6" />
                <!-- Visible connector bar -->
                <rect class="node-connector-bar" [attr.x]="NODE_WIDTH / 2 - 30" [attr.y]="NODE_HEIGHT - 2" width="60"
                    height="6" rx="3" />
                <!-- Connect label -->
                <text class="node-connector-label" [attr.x]="NODE_WIDTH / 2" [attr.y]="NODE_HEIGHT + 18"
                    text-anchor="middle" font-size="9">‚ö° drag to connect</text>
            </g>

            <!-- Delete button -->
            <g class="node-delete" [attr.transform]="'translate(' + (NODE_WIDTH - 6) + ', -6)'"
                (click)="deleteNode($event, node.id)">
                <circle r="14" fill="transparent" />
                <circle r="10" class="node-delete-bg" />
                <text x="0" y="1" text-anchor="middle" dominant-baseline="middle" fill="white" font-size="14"
                    font-weight="bold">√ó</text>
            </g>
        </g>
        }
    </svg>

    @if (isEmpty()) {
    <div class="canvas-empty">
        <div class="canvas-empty__icon">‚òÅÔ∏è</div>
        <h3 class="canvas-empty__title">Design Your Infrastructure</h3>
        <p class="canvas-empty__text">Click resources in the palette to add them to the canvas</p>
        <div class="canvas-empty__hint">
            <span>üñ±Ô∏è Click node to select ¬∑ Shift/Ctrl+click for multi-select</span>
            <span>üîó Drag bottom bar to connect ¬∑ edges auto-validate</span>
            <span>üñ±Ô∏è Ctrl+drag or middle-click to pan ¬∑ scroll to zoom</span>
            <span>‚å®Ô∏è Ctrl+C/V copy/paste ¬∑ Ctrl+D duplicate ¬∑ Delete to remove</span>
            <span>‚å®Ô∏è Ctrl+A select all ¬∑ Arrow keys to nudge</span>
        </div>
    </div>
    }

    <!-- Zoom Controls -->
    <div class="canvas-controls">
        <button class="canvas-controls__btn" (click)="zoomIn()" title="Zoom In">
            <span>+</span>
        </button>
        <span class="canvas-controls__zoom">{{ zoomPercent() }}%</span>
        <button class="canvas-controls__btn" (click)="zoomOut()" title="Zoom Out">
            <span>‚àí</span>
        </button>
        <button class="canvas-controls__btn canvas-controls__btn--text" (click)="resetZoom()" title="Reset Zoom">
            <span>Reset</span>
        </button>
        <button class="canvas-controls__btn canvas-controls__btn--text" (click)="fitToView()" title="Fit to View">
            <span>Fit</span>
        </button>
    </div>
</div>